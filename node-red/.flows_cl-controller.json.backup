[{"id":"a775a5b.b12bf58","type":"tab","label":"Flow 1"},{"id":"f25e104b.6303e","type":"http in","z":"a775a5b.b12bf58","name":"opi0cluster","url":"/opi0cluster","method":"get","upload":false,"swaggerDoc":"","x":60,"y":40,"wires":[["c02468ac.34bdf8"]]},{"id":"c02468ac.34bdf8","type":"function","z":"a775a5b.b12bf58","name":"","func":"function getNow(){\n    var d = new Date();\n    var n = d.getTime();\n    return n;    \n}\nvar timeoutdelayseconds =60;\nvar now = getNow();\nmsg.payload.fun = \"\";\n\n//take care of globals so we can work with locals\n    lTable = global.get(\"table\");\n    \n    if (lTable === undefined){\n        msg.payload.fun += \"undefined \";\n        lTable = [];\n        for (var i=0;i<255;i=i+1){\n            lTable[i] = {\"position\":i,\"mac\":\"default\",\"timeout\":now};\n        }\n        global.set(\"table\", lTable);\n    }else{\n        msg.payload.fun += \"defined \";\n    }\n    \nvar lTable = global.get(\"table\");\nvar use =0;\n\nif (msg.payload.register.includes(\"Controller\")){\n    use=0;    \n}else{\n    for (var i=1;i<255;i=i+1){\n        if (lTable[i].mac == msg.payload.register){\n             if (use == 0){use = i;}\n            lTable[i].mac= \"default1\";\n            lTable[i].timeout =\"0\";\n            //msg.payload.fun += \"already registered \";\n            //break;\n        }\n        if (lTable[i].timeout <= getNow()){\n            if (use == 0){use = i;}\n            //lTable[i].mac= \"default2\";\n            //lTable[i].timeout =\"0\";\n            lTable[i]= {};\n            lTable[i].position = i;\n            //break;\n        }\n        \n    }\n}\nlTable[use].timeout = getNow()+(1000*timeoutdelayseconds);\nlTable[use].timeleft = lTable[use].timeout- getNow();\nlTable[use].mac = msg.payload.register;\nlTable[use].khash = msg.payload.khash;\n\nglobal.set(\"table\", lTable);\n        \nmsg.payload.number = lTable[use].position;\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":80,"wires":[["c4a74422.f6d478","169919ec.4dc2e6"]]},{"id":"c4a74422.f6d478","type":"http response","z":"a775a5b.b12bf58","name":"","statusCode":"","headers":{},"x":370,"y":60,"wires":[]},{"id":"169919ec.4dc2e6","type":"debug","z":"a775a5b.b12bf58","name":"","active":true,"console":"false","complete":"payload","x":210,"y":140,"wires":[]},{"id":"6cd1079b.915798","type":"http in","z":"a775a5b.b12bf58","name":"","url":"/monitor","method":"get","upload":false,"swaggerDoc":"","x":70,"y":220,"wires":[["6ba465ec.eef2cc"]]},{"id":"5d16ba00.7a2428","type":"http response","z":"a775a5b.b12bf58","name":"","statusCode":"","headers":{},"x":470,"y":220,"wires":[]},{"id":"eae6efe7.6c184","type":"function","z":"a775a5b.b12bf58","name":"","func":"function getNow(){\n    var d = new Date();\n    var n = d.getTime();\n    return n;    \n}\n\nlTable = global.get(\"table\");\n\nif (lTable === undefined){\n    msg.payload.fun = \"undefined\"; \n}else{\n    msg.payload.table = global.get(\"table\"); \n}\n\nfor (var i=0;i<255;i=i+1){\n    if (lTable[i].mac==\"default\"){\n        break;\n    }\n    lTable[i].timeleft =Math.round((lTable[i].timeout-getNow())/1000);\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":600,"wires":[["84fcc550.47d8f8"]]},{"id":"5a92a192.ba73f","type":"debug","z":"a775a5b.b12bf58","name":"","active":true,"console":"false","complete":"false","x":610,"y":320,"wires":[]},{"id":"6ba465ec.eef2cc","type":"template","z":"a775a5b.b12bf58","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<HTML>\n<script type=\"text/javascript\" src=\"https://files.coinmarketcap.com/static/widget/currency.js\"></script>\n\n<div id=\"ticker\" class=\"coinmarketcap-currency-widget\" data-currency=\"magi\" data-base=\"USD\"  data-secondary=\"BTC\"></div>\n\n<div>\n<div id=\"clustersBase\" style=\"float: left;\">test</div>\n<div id=\"graphBase\" style=\"float: right;width: 50%;height: 100%\">test</div>\n</div>\n    \n    <script>\n\n\nfunction update(base){\n    var req = new XMLHttpRequest();\n    req.onreadystatechange = function () {\n        //console.log ( \"-\" += req.readyState += \"-\" & req.status+=\"-\"+=req.responseText);\n        if (req.readyState != 4 || req.status != 200) return;\n        document.getElementById(base.concat(\"Base\")).innerHTML = req.response;\n    };\n\n    req.open(\"GET\", \"http://192.168.1.19:1880/\".concat(base,\"Base\"), true);\n    req.send();\n}\ntof = function(){\n    update(\"clusters\");\n    update(\"graph\");\n    setTimeout(tof, 5/60*60*1000);\n    //window.location.reload(1);\n}\ntof();\n//setTimeout(tof, 30/60*60*1000);\n\n</script>\n</HTML>","output":"str","x":350,"y":220,"wires":[["5d16ba00.7a2428"]]},{"id":"19b46301.8b17dd","type":"function","z":"a775a5b.b12bf58","name":"getNow","func":"function getNow(){\n    var d = new Date();\n    var n = d.getTime();\n    return n;    \n}","outputs":1,"noerr":0,"x":149.16668701171875,"y":496,"wires":[[]]},{"id":"cba4d84.345ae28","type":"http in","z":"a775a5b.b12bf58","name":"","url":"/log","method":"get","upload":false,"swaggerDoc":"","x":63.16667175292969,"y":311.3333435058594,"wires":[["8d3acaee.6e11d8"]]},{"id":"8d3acaee.6e11d8","type":"function","z":"a775a5b.b12bf58","name":"","func":"msg.payload.result = \"ok\";\n\n//msg = new Buffer('hello world', 'utf8');\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":360,"wires":[["c04b50c.efb43b","c6426b9b.7f64f8","df5e05be.df0f98"]]},{"id":"c04b50c.efb43b","type":"http response","z":"a775a5b.b12bf58","name":"","statusCode":"","headers":{},"x":410,"y":360,"wires":[]},{"id":"e3f8f6f5.d704e8","type":"debug","z":"a775a5b.b12bf58","name":"LOG","active":true,"console":"false","complete":"payload","x":390,"y":480,"wires":[]},{"id":"c6426b9b.7f64f8","type":"file","z":"a775a5b.b12bf58","name":"","filename":"/node-red-log.log","appendNewline":true,"createDir":true,"overwriteFile":"false","x":450,"y":400,"wires":[]},{"id":"df5e05be.df0f98","type":"function","z":"a775a5b.b12bf58","name":"","func":"msg.payload.date=Date();\nreturn msg;","outputs":1,"noerr":0,"x":171.16668701171875,"y":432,"wires":[["e3f8f6f5.d704e8"]]},{"id":"535220f1.0fba2","type":"http in","z":"a775a5b.b12bf58","name":"","url":"/clustersBase","method":"get","upload":false,"swaggerDoc":"","x":110,"y":600,"wires":[["eae6efe7.6c184"]]},{"id":"f5baef97.2297e","type":"http response","z":"a775a5b.b12bf58","name":"","statusCode":"","headers":{},"x":510,"y":600,"wires":[]},{"id":"9c558f23.851fd","type":"debug","z":"a775a5b.b12bf58","name":"temp","active":true,"console":"false","complete":"payload","x":430,"y":1040,"wires":[]},{"id":"84fcc550.47d8f8","type":"template","z":"a775a5b.b12bf58","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<table border=\"1px\">\n    {{#payload.table}}\n    <tr>\n    <td>{{position}}</td>\n        <td>{{khash}}</td>\n            <td>{{mac}}</td>\n                <td>{{timeleft}}</td>\n    </tr>\n    {{/payload.table}}\n    </table>","output":"str","x":390,"y":600,"wires":[["f5baef97.2297e"]]},{"id":"7935bad3.453b44","type":"inject","z":"a775a5b.b12bf58","name":"","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":true,"x":107.16667175292969,"y":1041.3333740234375,"wires":[["d6387c76.2f01a"]]},{"id":"d6387c76.2f01a","type":"http request","z":"a775a5b.b12bf58","name":"","method":"GET","ret":"obj","url":"https://api.coinmarketcap.com/v1/ticker/magi/","tls":"","x":270,"y":1040,"wires":[["9c558f23.851fd","ca587e99.b0d36"]]},{"id":"ca587e99.b0d36","type":"file","z":"a775a5b.b12bf58","name":"","filename":"/XMGHistory.json.cvs","appendNewline":true,"createDir":false,"overwriteFile":"false","x":489.16668701171875,"y":1128.666748046875,"wires":[]},{"id":"d03c606.a6c6aa","type":"function","z":"a775a5b.b12bf58","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"x":301.16668701171875,"y":732,"wires":[["569b246e.6543ac"]]},{"id":"569b246e.6543ac","type":"template","z":"a775a5b.b12bf58","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<div id=\"yo\" style=\"width:  100%;height:  100%\"></div>\n<script src=\"https://www.gstatic.com/charts/loader.js\">\ngoogle.charts.load('44', {\n  callback: drawBackgroundColor,\n  packages: ['corechart']\n});\n\nfunction drawBackgroundColor() {\n  var c = [\n    [new Date('3/16/2016'), 3],\n    [new Date('3/17/2016'), 5],\n    [new Date('3/18/2016'), 7],\n    [new Date('3/19/2016'), 9],\n  ];\n\n  var data = new google.visualization.DataTable();\n  data.addColumn('date', 'Date');\n  data.addColumn('number', 'Distance');\n\n  data.addRows(c);\n\n  var options = {\n    hAxis: {\n      title: 'Time'\n    },\n    vAxis: {\n      title: 'Popularity'\n    },\n    backgroundColor: '#f1f8e9'\n  };\n\n  var chart = new google.visualization.LineChart(document.getElementById('yo'));\n  chart.draw(data, options);\n}\n</script>\n\n","output":"str","x":477.16668701171875,"y":734,"wires":[["7e530da3.89b184"]]},{"id":"814ab8d2.549ca8","type":"http in","z":"a775a5b.b12bf58","name":"","url":"/graphBase","method":"get","upload":false,"swaggerDoc":"","x":115.16667175292969,"y":739.3333740234375,"wires":[["d03c606.a6c6aa"]]},{"id":"7e530da3.89b184","type":"http response","z":"a775a5b.b12bf58","name":"","statusCode":"","headers":{},"x":657.1666870117188,"y":738.6666870117188,"wires":[]}]